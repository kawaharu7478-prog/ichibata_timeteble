<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>広電 列車運行図</title>
  <style>
    body {
      font-family: sans-serif;
    }
    svg {
      border: 1px solid #aaa;
      background: #f9f9f9;
    }
    .station {
      fill: white;
      stroke: black;
      stroke-width: 2px;
    }
    .station-label {
      font-size: 12px;
      text-anchor: middle;
    }
    .train {
      fill: red;
      stroke: black;
      stroke-width: 1px;
    }
  </style>
</head>
<body>
  <h2>広電 列車運行図</h2>
  <svg id="diagram" width="900" height="500"></svg>

  <script>
    const svg = document.getElementById("diagram");

    // 駅座標を拡大配置
    const stationSpacing = 120;
    const mainLineStations = [
      "広島", "横川", "西広島", "草津", "五日市", "宮島口"
    ];
    const branchStations = [
      "川跡", "大社"
    ];

    // 広島〜宮島口 本線
    const mainLineCoords = mainLineStations.map((name, i) => ({
      name: name,
      x: 100 + i * stationSpacing,
      y: 100
    }));

    // 川跡支線（川跡から南へ）
    const kawaatoMain = mainLineCoords.find(st => st.name === "西広島"); 
    const branchCoords = branchStations.map((name, i) => ({
      name: name,
      x: 100 + 3 * stationSpacing, // 西広島の真下
      y: 100 + (i + 1) * stationSpacing
    }));

    // SVG描画（本線）
    for (let i = 0; i < mainLineCoords.length - 1; i++) {
      const a = mainLineCoords[i];
      const b = mainLineCoords[i + 1];
      svg.innerHTML += `<line x1="${a.x}" y1="${a.y}" x2="${b.x}" y2="${b.y}" stroke="black" stroke-width="2"/>`;
    }

    // SVG描画（支線）
    for (let i = 0; i < branchCoords.length - 1; i++) {
      const a = branchCoords[i];
      const b = branchCoords[i + 1];
      svg.innerHTML += `<line x1="${a.x}" y1="${a.y}" x2="${b.x}" y2="${b.y}" stroke="black" stroke-width="2"/>`;
    }

    // 駅描画
    [...mainLineCoords, ...branchCoords].forEach(st => {
      svg.innerHTML += `<circle class="station" cx="${st.x}" cy="${st.y}" r="8"/>`;
      svg.innerHTML += `<text class="station-label" x="${st.x}" y="${st.y - 12}">${st.name}</text>`;
    });

    // 列車データ（位置は 0〜1 の割合）
    const trains = [
      { line: "main", pos: 0.2, dir: 1 },
      { line: "main", pos: 0.65, dir: -1 },
      { line: "branch", pos: 0.4, dir: 1 }
    ];

    function getTrainPosition(line, pos) {
      let coords = line === "main" ? mainLineCoords : branchCoords;
      let totalSegments = coords.length - 1;
      let exact = pos * totalSegments;
      let idx = Math.floor(exact);
      if (idx >= totalSegments) idx = totalSegments - 1;
      let t = exact - idx;

      const a = coords[idx];
      const b = coords[idx + 1];
      return {
        x: a.x + (b.x - a.x) * t,
        y: a.y + (b.y - a.y) * t,
        angle: Math.atan2(b.y - a.y, b.x - a.x) * 180 / Math.PI
      };
    }

    function drawTrains() {
      document.querySelectorAll(".train").forEach(el => el.remove());

      trains.forEach(tr => {
        const pos = getTrainPosition(tr.line, tr.pos);
        const angle = pos.angle + (tr.dir === 1 ? 0 : 180);
        svg.innerHTML += `
          <polygon class="train"
            points="-8,6 8,0 -8,-6"
            transform="translate(${pos.x},${pos.y}) rotate(${angle})"
          />
        `;
      });
    }

    function update() {
      trains.forEach(tr => {
        tr.pos += 0.002 * tr.dir;
        if (tr.pos > 1) tr.pos = 0;
        if (tr.pos < 0) tr.pos = 1;
      });
      drawTrains();
      requestAnimationFrame(update);
    }

    drawTrains();
    update();
  </script>
</body>
</html>
