<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>一畑電車 運行可視化</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: sans-serif; }
    .station text { font-size: 12px; }
    .train-label { font-size: 10px; pointer-events: none; }
  </style>
</head>
<body>
  <svg id="diagram" width="1200" height="800"></svg>

  <script>
    const svg = d3.select("#diagram");
    const width = +svg.attr("width");
    const height = +svg.attr("height");

    const stationsMain = ["松江温泉","ガーデン前","朝日ヶ丘","長江","秋鹿町","フォーゲル","高ノ宮","津ノ森","伊野灘","一畑口","園","湖遊館新駅","布崎","雲州平田","旅伏","美談","大寺","川跡","武志","大津町","科学館前","電鉄出雲市"];
    const stationsBranch = ["川跡","高浜","遥堪","浜山公園北口","出雲大社前"];

    const margin = {top: 50, left: 100};
    const stationSpacing = 30;
    const timeScale = d3.scaleTime()
      .domain([parseTime("1400"), parseTime("1530")])  // 表示範囲（サンプルに合わせて調整）
      .range([margin.left, width - 100]);

    function parseTime(hhmm) {
      if (!hhmm) return null;
      hhmm = hhmm.toString().padStart(4, "0");
      const h = +hhmm.slice(0,2);
      const m = +hhmm.slice(2,4);
      return new Date(2020, 0, 1, h, m);
    }

    // 駅座標
    const stationPos = {};
    stationsMain.forEach((s, i) => {
      stationPos[s] = {x: margin.left, y: margin.top + i * stationSpacing};
    });
    stationsBranch.forEach((s, i) => {
      stationPos[s] = {x: margin.left + 200, y: margin.top + (stationsMain.length-1 + i) * stationSpacing};
    });

    // 駅描画
    svg.selectAll(".station")
      .data([...stationsMain, ...stationsBranch])
      .enter()
      .append("g")
      .attr("class", "station")
      .attr("transform", d => `translate(${stationPos[d].x},${stationPos[d].y})`)
      .each(function(d) {
        d3.select(this).append("circle").attr("r", 3).attr("fill", "black");
        d3.select(this).append("text").attr("x", -10).attr("y", 4).attr("text-anchor", "end").text(d);
      });

    function getTrainStyle(name) {
      if (name.includes("A")) return {fill: "red", text: "white"};
      if (name.includes("B")) return {fill: "green", text: "white"};
      if (name.includes("C")) return {fill: "yellow", text: "black"};
      if (name.includes("D")) return {fill: "blue", text: "black"};
      if (name.includes("E")) return {fill: "none", text: "black"};
      if (name.includes("F")) return {fill: "cyan", text: "black"};
      if (name.includes("G")) return {fill: "orange", text: "white"};
      if (name.includes("H")) return {fill: "pink", text: "black"};
      if (name.includes("I")) return {fill: "lime", text: "black"};
      return {fill: "gray", text: "white"};
    }

    d3.csv("trains.csv").then(function(data) {
      data.forEach(d => {
        d.times = {};
        Object.keys(d).forEach(k => {
          if (stationsMain.includes(k) || stationsBranch.includes(k)) {
            if (d[k]) d.times[k] = parseTime(d[k]);
          }
        });
      });

      data.forEach(train => {
        const style = getTrainStyle(train.train_name);
        const stops = Object.entries(train.times).filter(([s,t]) => t).map(([s,t]) => ({station:s, time:t}));

        if (stops.length < 2) return;

        const line = d3.line()
          .x(d => timeScale(d.time))
          .y(d => stationPos[d.station].y);

        svg.append("path")
          .datum(stops)
          .attr("fill", "none")
          .attr("stroke", style.fill)
          .attr("stroke-width", 2)
          .attr("d", line);

        const marker = svg.append("g");
        const len = stops.length;
        let idx = 0;

        d3.interval(() => {
          idx = (idx+1) % len;
          marker.attr("transform", `translate(${timeScale(stops[idx].time)},${stationPos[stops[idx].station].y})`);
          marker.selectAll("*").remove();

          const w = 20 + train.train_name.length * 6;
          const h = 14;
          const dir = train.direction === "up" ? -1 : 1;
          const points = [
            [-w/2, -h/2],
            [w/2 - 5*dir, -h/2],
            [w/2*dir, 0],
            [w/2 - 5*dir, h/2],
            [-w/2, h/2]
          ];
          marker.append("polygon")
            .attr("points", points.map(p => p.join(",")).join(" "))
            .attr("fill", style.fill)
            .attr("stroke", "black");
          marker.append("text")
            .attr("text-anchor", "middle")
            .attr("dy", "0.35em")
            .attr("fill", style.text)
            .text(train.train_name);
        }, 1000);
      });
    });
  </script>
</body>
</html>
