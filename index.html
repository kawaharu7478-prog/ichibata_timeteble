<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>列車運行アニメーション</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: sans-serif; }
    .station { font-size: 12px; text-anchor: middle; }
    .time-label { font-size: 18px; font-weight: bold; }
  </style>
</head>
<body>
  <svg id="map" width="1600" height="900"></svg>

  <script>
    const svg = d3.select("#map");
    const width = +svg.attr("width");
    const height = +svg.attr("height");

    // 駅リスト（本線）
    const mainStations = [
      "松江温泉","ガーデン前","朝日ヶ丘","長江","秋鹿町","フォーゲル","高ノ宮","津ノ森","伊野灘",
      "一畑口","園","湖遊館新駅","布崎","雲州平田","旅伏","美談","大寺","川跡",
      "武志","大津町","科学館前","電鉄出雲市"
    ];

    // 支線
    const branchStations = ["川跡","高浜","遥堪","浜山公園北口","出雲大社前"];

    // レイアウト設定
    const stationSpacing = 70;   // 駅間隔（少し広く）
    const startX = 100;
    const startY = 120;

    // 本線の座標
    const stationPositions = {};
    mainStations.forEach((name, i) => {
      stationPositions[name] = {x: startX + i * stationSpacing, y: startY};
    });

    // 支線の座標
    const kawato = stationPositions["川跡"];
    branchStations.forEach((name, i) => {
      if (i === 0) {
        stationPositions[name] = kawato; // 川跡は共通
      } else {
        stationPositions[name] = {
          x: kawato.x + i * stationSpacing, // 川跡から右方向へ
          y: kawato.y + 150                 // 垂直に落としてから平行
        };
      }
    });

    // 路線の描画
    // 本線
    svg.append("line")
      .attr("x1", stationPositions["松江温泉"].x)
      .attr("y1", stationPositions["松江温泉"].y)
      .attr("x2", stationPositions["電鉄出雲市"].x)
      .attr("y2", stationPositions["電鉄出雲市"].y)
      .attr("stroke", "black");

    // 川跡から垂直に支線を下ろす
    svg.append("line")
      .attr("x1", kawato.x)
      .attr("y1", kawato.y)
      .attr("x2", kawato.x)
      .attr("y2", kawato.y + 150)
      .attr("stroke", "black");

    // 支線（平行部分）
    svg.append("line")
      .attr("x1", stationPositions["高浜"].x)
      .attr("y1", stationPositions["高浜"].y)
      .attr("x2", stationPositions["出雲大社前"].x)
      .attr("y2", stationPositions["出雲大社前"].y)
      .attr("stroke", "black");

    // 駅の描画
    Object.entries(stationPositions).forEach(([name, pos]) => {
      svg.append("circle")
        .attr("cx", pos.x)
        .attr("cy", pos.y)
        .attr("r", 5)
        .attr("fill", "black");

      svg.append("text")
        .attr("x", pos.x)
        .attr("y", pos.y - 10)
        .attr("class", "station")
        .text(name);
    });

    // 列車アイコン色設定
    function getTrainStyle(name) {
      if (name.includes("A")) return {fill: "red", text: "white"};
      if (name.includes("B")) return {fill: "green", text: "white"};
      if (name.includes("C")) return {fill: "yellow", text: "black"};
      if (name.includes("D")) return {fill: "blue", text: "black"};
      if (name.includes("E")) return {fill: "none", text: "black"};
      if (name.includes("F")) return {fill: "cyan", text: "black"};
      if (name.includes("G")) return {fill: "orange", text: "white"};
      if (name.includes("H")) return {fill: "pink", text: "black"};
      if (name.includes("I")) return {fill: "lime", text: "black"};
      return {fill: "gray", text: "white"};
    }

    // 現在時刻表示
    const timeLabel = svg.append("text")
      .attr("x", width / 2)
      .attr("y", 40)
      .attr("class", "time-label")
      .attr("text-anchor", "middle");

    // CSV読込
    d3.csv("trains.csv").then(data => {
      const trains = data.map(d => ({
        id: d.train_id,
        name: d.train_name,
        direction: d.direction,
        times: Object.fromEntries(
          Object.entries(d).filter(([k,v]) => k !== "train_id" && k !== "train_name" && k !== "direction" && v)
        )
      }));

      function update() {
        // 実時間を分単位で計算
        const now = new Date();
        const hh = now.getHours();
        const mm = now.getMinutes();
        const currentTime = hh * 100 + mm;

        timeLabel.text(`${hh.toString().padStart(2,"0")}:${mm.toString().padStart(2,"0")}`);

        svg.selectAll(".train").remove();

        trains.forEach(train => {
          const stations = Object.keys(train.times);
          let prev = null, next = null;

          for (let i = 0; i < stations.length; i++) {
            const t = parseInt(train.times[stations[i]]);
            if (t <= currentTime) prev = {station: stations[i], time: t};
            if (t > currentTime && !next) next = {station: stations[i], time: t};
          }

          if (!prev || !next) return;

          const p1 = stationPositions[prev.station];
          const p2 = stationPositions[next.station];
          if (!p1 || !p2) return;

          const ratio = (currentTime - prev.time) / (next.time - prev.time);
          const x = p1.x + (p2.x - p1.x) * ratio;
          const y = p1.y + (p2.y - p1.y) * ratio + (train.direction === "up" ? -20 : 20);

          const style = getTrainStyle(train.name);
          const w = 20 + train.name.length * 8;
          const h = 20;

          // 矢羽根型ポリゴン
          const points = train.direction === "up"
            ? `${x-w/2},${y+h/2} ${x+w/2-5},${y+h/2} ${x+w/2},${y} ${x+w/2-5},${y-h/2} ${x-w/2},${y-h/2}`
            : `${x-w/2+5},${y-h/2} ${x+w/2},${y-h/2} ${x+w/2},${y+h/2} ${x-w/2+5},${y+h/2} ${x-w/2},${y}`;

          svg.append("polygon")
            .attr("points", points)
            .attr("fill", style.fill)
            .attr("stroke", "black")
            .attr("class", "train");

          svg.append("text")
            .attr("x", x)
            .attr("y", y+4)
            .attr("text-anchor", "middle")
            .attr("fill", style.text)
            .attr("font-size", "12px")
            .attr("class", "train")
            .text(train.name);
        });
      }

      setInterval(update, 1000); // 実時間に合わせて1秒ごとに更新
    });
  </script>
</body>
</html>
