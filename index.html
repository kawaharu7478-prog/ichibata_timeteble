<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>列車可視化</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
    }
    .station {
      fill: black;
    }
    .station-label {
      font-size: 10px;
      text-anchor: middle;
    }
    .train {
      fill: steelblue;
      stroke: black;
      stroke-width: 1px;
    }
    .train-label {
      font-size: 10px;
      fill: white;
      text-anchor: middle;
      dominant-baseline: middle;
    }
  </style>
</head>
<body>
  <h2>列車可視化</h2>
  <svg id="map" width="1200" height="600"></svg>
  <script>
    const mainStations = [
      "松江温泉","ガーデン前","朝日ヶ丘","長江","秋鹿町","フォーゲル","高ノ宮","津ノ森","伊野灘",
      "一畑口","園","湖遊館新駅","布崎","雲州平田","旅伏","美談","大寺","川跡","武志","大津町","科学館前","電鉄出雲市"
    ];

    const branchStations = ["川跡","高浜","遥堪","浜山公園北口","出雲大社前"];

    const svg = d3.select("#map");

    // 駅の座標を生成
    const stationPositions = {};
    const startX = 80;
    const startY = 100;
    const spacing = 50;

    // 本線を横一列
    mainStations.forEach((name, i) => {
      stationPositions[name] = { x: startX + i * spacing, y: startY };
    });

    // 川跡から下に支線
    branchStations.forEach((name, i) => {
      if (i === 0) return; // 川跡は既に配置済み
      stationPositions[name] = {
        x: stationPositions["川跡"].x,
        y: stationPositions["川跡"].y + i * spacing
      };
    });

    // 駅を描画
    svg.selectAll("circle.station")
      .data(Object.entries(stationPositions))
      .enter()
      .append("circle")
      .attr("class", "station")
      .attr("r", 4)
      .attr("cx", d => d[1].x)
      .attr("cy", d => d[1].y);

    svg.selectAll("text.station-label")
      .data(Object.entries(stationPositions))
      .enter()
      .append("text")
      .attr("class", "station-label")
      .attr("x", d => d[1].x)
      .attr("y", d => d[1].y - 8)
      .text(d => d[0]);

    // 列車データを読み込み
    d3.csv("trains.csv").then(data => {
      const now = 1405; // 例: 14:05の時刻を想定

      data.forEach(train => {
        const times = Object.entries(train).filter(([k, v]) => mainStations.includes(k) || branchStations.includes(k));
        let prev = null, next = null;

        for (let [station, time] of times) {
          if (time && +time <= now) prev = { station, time: +time };
          if (time && +time > now && !next) {
            next = { station, time: +time };
          }
        }

        if (prev && next) {
          const posPrev = stationPositions[prev.station];
          const posNext = stationPositions[next.station];
          const ratio = (now - prev.time) / (next.time - prev.time);
          const x = posPrev.x + (posNext.x - posPrev.x) * ratio;
          const y = posPrev.y + (posNext.y - posPrev.y) * ratio;

          // 列車アイコン（矢印っぽい多角形）
          const trainWidth = 40;
          const trainHeight = 20;
          const points = [
            [x - trainWidth/2, y - trainHeight/2],
            [x + trainWidth/2, y - trainHeight/2],
            [x + trainWidth/2 + 10, y],
            [x + trainWidth/2, y + trainHeight/2],
            [x - trainWidth/2, y + trainHeight/2]
          ];
          svg.append("polygon")
            .attr("points", points.map(p => p.join(",")).join(" "))
            .attr("class", "train");

          svg.append("text")
            .attr("class", "train-label")
            .attr("x", x)
            .attr("y", y)
            .text(train.train_name);
        }
      });
    });
  </script>
</body>
</html>
