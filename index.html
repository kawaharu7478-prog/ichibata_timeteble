<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>列車走行位置表示</title>
  <style>
    body { font-family: sans-serif; background: #f8f8f8; }
    #time { font-size: 24px; font-weight: bold; margin: 20px; text-align: center; }
    .line { position: relative; margin: 80px 20px; }
    .station {
      position: absolute; text-align: center;
      width: 100px; transform: translateX(-50%);
    }
    .station::before {
      content: ''; position: absolute; top: 20px; left: 50%;
      width: 10px; height: 10px; background: black; border-radius: 50%;
      transform: translateX(-50%);
    }
    .track {
      position: absolute; height: 2px; background: black; top: 25px;
    }
    .branch-track { position: absolute; width: 2px; background: black; }
    .train {
      position: absolute; padding: 2px 8px; font-size: 12px;
      white-space: nowrap; text-align: center;
      clip-path: polygon(0% 0%, 90% 0%, 100% 50%, 90% 100%, 0% 100%);
    }
    .train.down {
      clip-path: polygon(10% 0%, 100% 0%, 100% 100%, 10% 100%, 0% 50%);
    }
    /* 色分けルール */
    .A { background: red; color: white; }
    .B { background: green; color: white; }
    .C { background: yellow; color: black; }
    .D { background: blue; color: black; }
    .E { background: transparent; color: black; border: 2px solid black; }
    .F { background: cyan; color: black; }
    .G { background: orange; color: white; }
    .H { background: pink; color: black; }
    .I { background: yellowgreen; color: black; }
  </style>
</head>
<body>
  <div id="time">--:--</div>
  <div id="map"></div>

  <script>
    // 本線と支線の駅
    const mainStations = [
      "松江温泉","ガーデン前","朝日ヶ丘","長江","秋鹿町","フォーゲル","高ノ宮","津ノ森","伊野灘","一畑口",
      "園","湖遊館新駅","布崎","雲州平田","旅伏","美談","大寺","川跡","武志","大津町","科学館前","電鉄出雲市"
    ];
    const branchStations = ["川跡","高浜","遥堪","浜山公園北口","出雲大社前"];

    const stationPos = {}; // 駅座標
    const spacingX = 150;  // 横方向間隔
    const spacingY = 120;  // 支線の縦間隔

    function drawLines() {
      const map = document.getElementById("map");
      map.innerHTML = "";

      // 本線
      const mainLine = document.createElement("div");
      mainLine.className = "line";
      map.appendChild(mainLine);

      mainStations.forEach((st, i) => {
        const x = 100 + i * spacingX;
        const y = 200;
        stationPos[st] = {x, y};
        const station = document.createElement("div");
        station.className = "station";
        station.style.left = x + "px";
        station.style.top = y + "px";
        station.innerHTML = st;
        mainLine.appendChild(station);

        if (i > 0) {
          const prevX = 100 + (i-1) * spacingX;
          const track = document.createElement("div");
          track.className = "track";
          track.style.left = prevX + "px";
          track.style.top = (y+25) + "px";
          track.style.width = spacingX + "px";
          mainLine.appendChild(track);
        }
      });

      // 川跡分岐
      const kawato = stationPos["川跡"];
      branchStations.forEach((st, i) => {
        const x = kawato.x + i * spacingX;
        const y = kawato.y + (i === 0 ? 0 : spacingY);
        stationPos[st + "_branch"] = {x, y};
        if (i > 0) {
          const station = document.createElement("div");
          station.className = "station";
          station.style.left = x + "px";
          station.style.top = y + "px";
          station.innerHTML = st;
          map.appendChild(station);

          if (i === 1) {
            // 川跡から垂直
            const vline = document.createElement("div");
            vline.className = "branch-track";
            vline.style.left = kawato.x + "px";
            vline.style.top = kawato.y + 25 + "px";
            vline.style.height = spacingY + "px";
            map.appendChild(vline);
          }
          // 横に並行
          const track = document.createElement("div");
          track.className = "track";
          track.style.left = (x - spacingX) + "px";
          track.style.top = (y+25) + "px";
          track.style.width = spacingX + "px";
          map.appendChild(track);
        }
      });
    }

    // CSV読み込み
    async function loadTrains() {
      const res = await fetch("trains.csv");
      const text = await res.text();
      return parseCSV(text);
    }

    function parseCSV(text) {
      const lines = text.trim().split("\n").map(l => l.split(","));
      const header = lines[0];
      return lines.slice(1).map(row => {
        const obj = {};
        header.forEach((h, i) => obj[h] = row[i]);
        return obj;
      });
    }

    // 時刻を分に
    function toMinutes(t) {
      if (!t || t === "") return null;
      const h = parseInt(t.slice(0,2),10);
      const m = parseInt(t.slice(2),10);
      return h*60+m;
    }

    // 列車表示更新
    function updateTrains(trains) {
      const now = new Date();
      const nowM = now.getHours()*60 + now.getMinutes();
      document.getElementById("time").textContent =
        `${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`;

      // 既存の列車消去
      document.querySelectorAll(".train").forEach(e => e.remove());

      trains.forEach(train => {
        const dir = train["direction"];
        const stations = mainStations.concat(branchStations.slice(1).map(s => s+"_branch"));
        const times = stations.map(st => toMinutes(train[st.replace("_branch","")]));

        for (let i=0; i<stations.length-1; i++) {
          const t1 = times[i], t2 = times[i+1];
          if (!t1 || !t2) continue;

          let inSection = false;
          if (dir === "up" && t1 <= nowM && nowM <= t2) inSection = true;
          if (dir === "down" && t2 <= nowM && nowM <= t1) inSection = true;
          if (!inSection) continue;

          const pos1 = stationPos[stations[i]];
          const pos2 = stationPos[stations[i+1]];
          const ratio = (nowM - t1) / (t2 - t1);
          const r = (dir === "down") ? 1 - ratio : ratio;
          const x = pos1.x + (pos2.x - pos1.x)*r;
          const yBase = pos1.y + (pos2.y - pos1.y)*r;
          const y = (dir === "up") ? yBase - 30 : yBase + 40;

          const trainDiv = document.createElement("div");
          trainDiv.className = "train " + dir;
          trainDiv.textContent = train["train_name"];
          "ABCDEFGHI".split("").forEach(c => {
            if (train["train_name"].includes(c)) trainDiv.classList.add(c);
          });
          trainDiv.style.left = x + "px";
          trainDiv.style.top = y + "px";
          document.getElementById("map").appendChild(trainDiv);
          break;
        }
      });
    }

    async function main() {
      drawLines();
      const trains = await loadTrains();
      setInterval(()=>updateTrains(trains), 10000);
      updateTrains(trains);
    }
    main();
  </script>
</body>
</html>
